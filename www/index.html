<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ndj-lib Reborn</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #splash { position: fixed; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: 0.8s; }
        .logo { border: 2px solid #fff; padding: 20px; font-weight: bold; font-size: 24px; border-radius: 12px; }
        #app { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .header { margin-bottom: 40px; text-align: center; }
        h1 { font-size: 20px; letter-spacing: 3px; margin: 0; }
        .tag { font-size: 10px; color: #555; margin-top: 5px; }
        input { width: 100%; max-width: 320px; padding: 18px; background: #0a0a0a; border: 1px solid #1a1a1a; color: #00ff41; border-radius: 12px; text-align: center; font-family: monospace; margin-bottom: 20px; outline: none; }
        .btn { width: 100%; max-width: 320px; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .btn-activate { background: #5865F2; color: #fff; }
        .btn-stop { background: #ff4444; color: #fff; display: none; margin-top: 15px; }
        #log { width: 100%; max-width: 320px; height: 120px; margin-top: 30px; font-family: monospace; font-size: 11px; color: #666; overflow-y: auto; text-align: left; border-left: 1px solid #222; padding-left: 15px; }
        .ln-green { color: #00ff41; }
        .ln-yellow { color: #ffcc00; }
        .ln-red { color: #ff4444; }
    </style>
</head>
<body>

    <div id="splash"><div class="logo">NDJ-LIB</div></div>

    <div id="app">
        <div class="header">
            <h1>REBORN SYSTEM</h1>
            <div class="tag">PORT OFICIAL MOBILE</div>
        </div>
        <input type="password" id="bot-token" placeholder="DISCORD BOT TOKEN">
        <button id="main-btn" class="btn btn-activate" onclick="ativarBot()">LIGAR BOT</button>
        <button id="stop-btn" class="btn btn-stop" onclick="finalizarSistema()">FINALIZAR EXECU√á√ÉO</button>
        <div id="log"></div>
    </div>

    <script src="capacitor.js"></script>
    <script>
        const { LocalNotifications } = Capacitor.Plugins;
        const logBox = document.getElementById('log');
        const mainBtn = document.getElementById('main-btn');
        const stopBtn = document.getElementById('stop-btn');
        let socket = null;
        let heartbeatInterval = null;

        function addLog(text, colorClass = '') {
            const entry = document.createElement('div');
            entry.className = colorClass;
            entry.innerText = `[SYS] ${text}`;
            logBox.prepend(entry);
        }

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                }, 800);
            }, 3000);
        };

        // Fun√ß√£o para Registrar Comandos Slash via API REST
        async function registrarSlash(token) {
            try {
                // Primeiro pegamos o ID do bot usando o token
                const meResp = await fetch('https://discord.com/api/v10/users/@me', {
                    headers: { Authorization: `Bot ${token}` }
                });
                const meData = await meResp.json();
                const appId = meData.id;

                addLog(`Registrando Slash para ID: ${appId}...`, "ln-yellow");

                const response = await fetch(`https://discord.com/api/v10/applications/${appId}/commands`, {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bot ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([{
                        name: "testar",
                        description: "Comando de teste Ndj-lib Reborn",
                        type: 1
                    }])
                });

                if (response.ok) addLog("‚úÖ Comando /testar cadastrado!", "ln-green");
                else addLog("‚ùå Erro no cadastro Slash.", "ln-red");
            } catch (e) {
                addLog("‚ùå Falha na conex√£o REST.", "ln-red");
            }
        }

        // Fun√ß√£o para conectar ao Gateway (Ficar Online)
        function conectarGateway(token) {
            socket = new WebSocket('wss://gateway.discord.gg/?v=10&encoding=json');

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const { op, t, d } = data;

                if (op === 10) { // Hello
                    const interval = d.heartbeat_interval;
                    heartbeatInterval = setInterval(() => {
                        socket.send(JSON.stringify({ op: 1, d: null }));
                    }, interval);

                    // Identificar (Login)
                    socket.send(JSON.stringify({
                        op: 2,
                        d: {
                            token: token,
                            intents: 513, // Guilds + Guild Messages
                            properties: { os: 'android', browser: 'capacitor', device: 'mobile' }
                        }
                    }));
                }

                if (t === 'READY') {
                    addLog(`‚úÖ Bot Online: ${d.user.username}#${d.user.discriminator}`, "ln-green");
                    setupNotification();
                }
            };

            socket.onerror = () => addLog("‚ùå Erro de WebSocket.", "ln-red");
            socket.onclose = () => addLog("üîå Conex√£o encerrada.", "ln-yellow");
        }

        async function setupNotification() {
            await LocalNotifications.registerActionTypes({
                types: [{ id: 'NDJ_ACTIONS', actions: [{ id: 'fechar', title: 'ENCERRAR BOT', destructive: true }] }]
            });
            await LocalNotifications.schedule({
                notifications: [{
                    title: "Ndj-lib: Ativa",
                    body: "Bot est√° online em segundo plano.",
                    id: 1,
                    actionTypeId: 'NDJ_ACTIONS',
                    ongoing: true
                }]
            });
        }

        async function ativarBot() {
            const token = document.getElementById('bot-token').value;
            if(!token) return alert("Token inv√°lido.");

            mainBtn.disabled = true;
            mainBtn.innerText = "SINCRO...";

            await registrarSlash(token);
            conectarGateway(token);

            mainBtn.style.display = 'none';
            stopBtn.style.display = 'block';
        }

        async function finalizarSistema() {
            addLog("Desligando...", "ln-yellow");
            if(socket) socket.close();
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            await LocalNotifications.cancel({ notifications: [{ id: 1 }] });

            setTimeout(() => {
                stopBtn.style.display = 'none';
                mainBtn.style.display = 'block';
                mainBtn.disabled = false;
                mainBtn.innerText = "LIGAR BOT";
            }, 1000);
        }

        LocalNotifications.addListener('localNotificationActionPerformed', (action) => {
            if (action.actionId === 'fechar') finalizarSistema();
        });
    </script>
</body>
</html>
