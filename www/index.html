<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ndj-lib Reborn</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; color: #fff; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #splash { position: fixed; width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: 0.8s; }
        .logo { border: 2px solid #fff; padding: 20px; font-weight: bold; font-size: 24px; border-radius: 12px; }
        #app { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .header { margin-bottom: 40px; text-align: center; }
        h1 { font-size: 20px; letter-spacing: 3px; margin: 0; }
        .tag { font-size: 10px; color: #555; margin-top: 5px; }
        input { width: 100%; max-width: 320px; padding: 18px; background: #0a0a0a; border: 1px solid #1a1a1a; color: #00ff41; border-radius: 12px; text-align: center; font-family: monospace; margin-bottom: 20px; outline: none; }
        .btn { width: 100%; max-width: 320px; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .btn-activate { background: #5865F2; color: #fff; }
        .btn-stop { background: #ff4444; color: #fff; display: none; margin-top: 15px; }
        #log { width: 100%; max-width: 320px; height: 120px; margin-top: 30px; font-family: monospace; font-size: 11px; color: #666; overflow-y: auto; text-align: left; border-left: 1px solid #222; padding-left: 15px; }
        .ln-green { color: #00ff41; }
        .ln-yellow { color: #ffcc00; }
        .ln-red { color: #ff4444; }
    </style>
</head>
<body>

    <div id="splash"><div class="logo">NDJ-LIB</div></div>

    <div id="app">
        <div class="header">
            <h1>REBORN SYSTEM</h1>
            <div class="tag">PORT OFICIAL MOBILE</div>
        </div>
        <input type="password" id="bot-token" placeholder="DISCORD BOT TOKEN">
        <button id="main-btn" class="btn btn-activate" onclick="ativarBot()">LIGAR BOT</button>
        <button id="stop-btn" class="btn btn-stop" onclick="finalizarSistema()">FINALIZAR EXECU√á√ÉO</button>
        <div id="log"></div>
    </div>

    <script src="capacitor.js"></script>
    <script>
        const { LocalNotifications, CapacitorHttp } = Capacitor.Plugins;
        const logBox = document.getElementById('log');
        const mainBtn = document.getElementById('main-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        let socket = null;
        let heartbeatInterval = null;
        let watchdogInterval = null;
        let currentToken = "";

        function addLog(text, colorClass = '') {
            const entry = document.createElement('div');
            entry.className = colorClass;
            entry.innerText = `> ${text}`;
            logBox.prepend(entry);
        }

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                }, 800);
            }, 3000);
        };

        // Watchdog: Verifica a conex√£o a cada 20 segundos
        function startWatchdog() {
            if(watchdogInterval) clearInterval(watchdogInterval);
            watchdogInterval = setInterval(() => {
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    addLog("üîÑ Conex√£o inst√°vel. Reconectando...", "ln-yellow");
                    conectarGateway(currentToken);
                } else {
                    console.log("Watchdog: Socket OK");
                }
            }, 20000); 
        }

        async function registrarSlash(token) {
            try {
                addLog("Sincronizando Comandos...", "ln-yellow");
                const meResp = await CapacitorHttp.get({
                    url: 'https://discord.com/api/v10/users/@me',
                    headers: { 'Authorization': `Bot ${token}` }
                });
                
                if (meResp.status !== 200) throw new Error("Token Inv√°lido");

                const appId = meResp.data.id;
                const regResp = await CapacitorHttp.request({
                    url: `https://discord.com/api/v10/applications/${appId}/commands`,
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bot ${token}`,
                        'Content-Type': 'application/json'
                    },
                    data: [{
                        name: "testar",
                        description: "Comando Ndj-lib Reborn Mobile",
                        type: 1
                    }]
                });

                if (regResp.status <= 204) addLog("‚úÖ Slash /testar Atualizado", "ln-green");
            } catch (e) {
                addLog("‚ùå Erro REST: " + e.message, "ln-red");
                throw e;
            }
        }

        function conectarGateway(token) {
            currentToken = token;
            if (socket) { socket.onclose = null; socket.close(); }

            socket = new WebSocket('wss://gateway.discord.gg/?v=10&encoding=json');

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                const { op, t, d } = data;

                if (op === 10) { // HELLO
                    if (heartbeatInterval) clearInterval(heartbeatInterval);
                    heartbeatInterval = setInterval(() => {
                        if(socket.readyState === WebSocket.OPEN)
                            socket.send(JSON.stringify({ op: 1, d: null }));
                    }, d.heartbeat_interval);

                    socket.send(JSON.stringify({
                        op: 2,
                        d: {
                            token: token,
                            intents: 1, 
                            properties: { os: 'android', browser: 'native', device: 'mobile' }
                        }
                    }));
                }

                if (t === 'INTERACTION_CREATE') {
                    addLog("üì© Slash detectado!", "ln-green");
                    
                    // Resposta via CapacitorHttp (Evita erro de fetch no callback)
                    const resOptions = {
                        url: `https://discord.com/api/v10/interactions/${d.id}/${d.token}/callback`,
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        data: {
                            type: 4,
                            data: { content: "üöÄ **Ndj-lib Reborn:** Sistema Online e Monitorado!" }
                        }
                    };
                    CapacitorHttp.post(resOptions).catch(e => console.error("Erro callback", e));
                }

                if (t === 'READY') {
                    addLog(`‚úÖ Bot Online: ${d.user.username}`, "ln-green");
                    setupNotification();
                    startWatchdog();
                }
            };

            socket.onclose = () => {
                console.log("Socket fechado");
            };

            socket.onerror = (e) => {
                addLog("‚ö†Ô∏è Erro de Conex√£o", "ln-red");
            };
        }

        async function setupNotification() {
            try {
                await LocalNotifications.requestPermissions();
                await LocalNotifications.schedule({
                    notifications: [{
                        title: "Ndj-lib: Ativa",
                        body: "O bot est√° online no seu celular.",
                        id: 1,
                        ongoing: true,
                        sticky: true
                    }]
                });
            } catch (e) { console.error(e); }
        }

        async function ativarBot() {
            const token = document.getElementById('bot-token').value;
            if(!token) return;

            mainBtn.disabled = true;
            mainBtn.innerText = "SINCRO...";

            try {
                await registrarSlash(token);
                conectarGateway(token);
                mainBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } catch (e) {
                mainBtn.disabled = false;
                mainBtn.innerText = "LIGAR BOT";
            }
        }

        async function finalizarSistema() {
            addLog("Encerrando...", "ln-yellow");
            if(socket) socket.close();
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            if(watchdogInterval) clearInterval(watchdogInterval);
            await LocalNotifications.cancel({ notifications: [{ id: 1 }] }).catch(()=>{});

            setTimeout(() => {
                stopBtn.style.display = 'none';
                mainBtn.style.display = 'block';
                mainBtn.disabled = false;
                mainBtn.innerText = "LIGAR BOT";
                addLog("BOT DESLIGADO.");
            }, 1000);
        }
    </script>
</body>
</html>
